*******************************************************************************
*****                                                                     *****
*****                        USER1.HP7550.DOC                             *****
*****                           Version 8                                 *****
*****                                                                     *****
*****     Programming Notes for the Hewlitt Packard 7550 Print Server     *****
*****                                                                     *****
*****      Copyright (c) 1987                                             *****
*****      David M. Krowitz                                               *****
*****      Massachusetts Institute of Technology                          *****
*****      Department of Earth, Atmospheric, and Planetary Sciences       *****
*******************************************************************************



Interfacing the Plotter with the Apollo
---------------------------------------

    We have interfaced our HP 7550 plotter to an Apollo DN320 using a 3-wire
RS232-C null modem cable. The wiring of the cable is: pin 2 - pin 3, pin 3 - pin 2,
and pin 7 - pin 7 (ie. cross the data receive and data transmit wires, and connect
the signal ground wires). We are using the X-ON/X-OFF protocal to control the flow
of data between the Apollo and the plotter rather than using the DTR and CTS signals
in the RS232-C cable. The SIO line characteristics necessary to run the plotter
using X-ON/X-OFF are set up in the routine USER1_INIT. Note that HP 7550 has two
RS232-C connectors. One labelled COMPUTER and the other labeled TERMINAL. Either
connector can be used, but when the TERMINAL connector is used, the plotter echos
all of the characters it receives on this line. Also, the TERMINAL connector does
not require a null modem cable. A regular straight through cable (pin 2 - pin 2,
pin 3 - pin 3, and pin 7 - pin 7) is used in this case.

    The HP 7550 plotter must be set up through the font panel to operate with
the RS232-C line. The parameters which need to be selected from the front panel
are:
        HP-IB       MONITOR
        STANDARD    SERIAL     ===> Select SERIAL to set up RS232-C line.

        DATA FLOW
        BYPASS      HANDSHAKE  ===> Select DATA FLOW to set up port selection.
                                    The data flow menu should be set to the
                                    REMOTE and STANDALONE selections. Use the
                                    LOCAL and STANDALONE selections if using
                                    the RS232-C port labelled TERMINAL rather
                                    than the port labelled COMPUTER.

        DATA FLOW
        BYPASS      HANDSHAKE  ===> Select HANDSHAKE to set up flow-control protocal.
                                    The handshake menu should be set to the
                                    XON/XOFF and DIRECT selections.

        DUPLEX      PARITY
        BAUD                   ===> Select DUPLEX to set up full/half duplex.
                                    The duplex menu should be set to the
                                    DUPLEX FULL selection.

        DUPLEX      PARITY
        BAUD                   ===> Select PARITY to set up parity and bits/char.
                                    The parity menu should be set to the
                                    8-BITS and NONE selections.
                                    
        DUPLEX      PARITY
        BAUD                   ===> Select BAUD to set up baud rate to the value
                                    specified in the plotter configuration
                                    file (HP7550.CONFIG).

    Refer to the "HP 7550A Graphics Plotter Operation and Interconnection Manual"
for detailed information on how to use the plotter's front panel to set up the
parameters listed above.


Description of the Plot Server Routines
---------------------------------------

    The HP7550 print server program consists of six main subroutines (procedures)
which are compiled and then bound to the standard print server program (/COM/PRSVR)
supplied by Apollo. The subroutines are: USER1_INIT, USER1_WRITE, USER1_FLUSH,
USER1_CLOSE, USER1_SET_MODE, and USER1_RETURN_INFO. Section 5.7 of Administering
Your DOMAIN System gives a general description of the standard print server
supplied by Apollo and the steps needed to generate a print server for a printer
(or plotter) other than those supported by Apollo. The arguments to the
user-supplied subroutines and the format of the data passed to the subroutines
are defined in the Apollo supplied insert files /SYS/INS/PRSVR.INS.PAS or
/SYS/INS/PRSVR.INS.C which, while defining the options and data types doesn't
really tell you what these various options are supposed to do. To get that
information, you either have to call Apollo or you just have to play with the
print (plot) server for awhile and see how it responds to your poking and prying.
Unfortunately for those of you who program in Fortran, there is no insert file for
that language - you just have to learn Pascal.

    The USER1_INIT subroutine is called once by the plot server when it starts up.
The subroutine is given the line number of the SIO line to which the plotter is 
connected and the baud rate of that SIO line. Both of these numbers are read from
the plotter configuration file (HP.CONFIG) by the plot server at startup time.
The USER1_INIT subroutine opens the specified SIO line for stream output and then
sets the necessary SIO line characteristics. These include the use of X-ON/X-OFF
by both the Apollo node and the printer (input_sync and host_sync), turning off
the echoing of characters which the plotter may send to the host (something which
is never really done except for X-ON and X-OFF), disabling the quit character on
the SIO line (so if the plotter accidentally glitches it can't kill the plot
server process), and the parity, number of bits per character, and number of
stop bits of the characters being transmitted. After defining the SIO line for
the plotter, USER1_INIT also initializes several strings of control characters
for the plotter, resets various output-mode and warning message flags. Finally,
USER1_INIT sends the plotter-init command to the HP 7550 to make sure the plotter
is correctly initialized.

    The USER1_WRITE subroutine does most of the work of the plot server. This
subroutine is called from the plot server to perform the actual output of the
data to the HP7550 plotter. The subroutine is given a buffer of up to 2048
characters and a buffer length. In practice, I have never seen the buffer length
exceed 256 bytes. The USER1_WRITE subroutine checks the current plotter output
mode and then outputs the contents of the buffer according to the mode. The mode
is set by the plot server calling the USER1_SET_MODE subroutine prior to the
first call to USER1_WRITE for the current output file. There are three possible
output modes: 'text', 'transparent', and 'plot'.

    If the current output mode is 'text' (ie. a PRF command with no switches),
the print server outputs an error message warning that the plotter is unable
to print text files and throws away the output buffer. The warning message is
only printed once at the beginning of a new file being output in text-mode, not
during each line of output. The warning message is also suppressed when the
print server tries to send a form-feed character (to eject the current page) to
the plotter in text-mode after finishing the output of a plot-mode or
transparent-mode file.

    If the current output mode is 'transparent' (ie. a PRF -TRANSPARENT command),
the print server sends the contents of the output file to the printer with no
modifications. USER1_WRITE is called once for each line in the file (same as with
'text' mode), but no page headers are inserted into the output stream. In this
output mode USER1_WRITE does nothing except to dump the buffer to the HP7550's
output stream.

    If the current output mode is 'plot' (ie. a PRF -PLOT command), the print
server checks that the output file is a GMF bitmap file, calls USER1_SET_MODE
twice to set the vertical and horizontal sizes of the bitmap, and then calls
USER1_WRITE once for each horizontal scan line in the bitmap. The print server
will not attempt to print bitmap files unless the PLOT_MODE switch in the
printer's configuration file (ie. HP7550.CONFIG --  which is specified on the
command line which started the print server) is set to ON. If the PLOT_MODE
switch is on, then USER1_WRITE will output an error message warning that the
plotter is unable to print bitmap files and will throw away the output buffer.
The warning message is only output once at the beginning of the file, not during
each buffer of output.

    The USER1_SET_MODE subroutine is called by the plot server prior to the
output of each file being printed to set the proper plotter output mode and to set
such things as the bitmap size (for plot mode files). The plot server may also
call USER1_SET_MODE after the end of an output file to reset the plotter mode or
to change the plotter mode to 'text' so it can output a top-of-page command
(ie. a form feed) after finishing the printing of a bitmap or text-mode file.
As of version 5 of the HP7550 plotter server, the USER1_SET_MODE routine
checks the 'WEIGHT' option of the PRF command to determine which kind of
paper the user wanted their output to be plotted on. If the pen carosel currently
loaded in the plotter is not the type requested by the user then the 
plotter will request that the pens (and paper) be changed.



    The USER1_FLUSH subroutine is called once at the end of each file output by
the plot server and also in between changing plotter output modes. This routine
checks if the output mode is 'transparent' and if it is, USER1_FLUSH sends the
plotter the DF and PG commands to reset the HP 7550 to its default status (clearing
any special plotter modes which the output file may have set up) and to unload the
current page and to load a new piece of paper. Note that the PG command will
eject the current page only if the plotter has actually written something on the
paper.

    The USER1_CLOSE subroutine is only called when the plot server is stopping
permanently (as opposed to waiting between files). All that it does is to close
the plotter's output stream.


Version 3
---------

    The USER1_INIT routine now reports any errors which it encounters while
attempting to set up the SIO line for the printer. Seperate error messages are
generated for each SIO line parameter to aid in locating any problems with the
SIO line.


Version 4
---------

    Version 4 of the HP7550 USER1 routines is compatible with the AEGIS
SR9.0 version of PRSVR. It should also be backwards compatible with the
SR8.0 version of the print server.


Version 5
---------

    Added ability to check which kind of pens the user wants to be used
for their plot and to ask for pens to be changed if necessary. (note
that the plotter detects which kind of PEN CAROSEL is loaded in the
plotter, not what kind of pens are in the carosel). The command
'PRF -WEIGHT LIGHT' requests that the plot be made with transparency
pens, 'PRF -WEIGHT MEDIUM' requests fiber-tipped paper pens, and
'PRF -WEIGHT BOLD' requests drafting (vellum) pens. The default
value is 'MEDIUM' (paper pens). If the wrong pen carosel is loaded,
the plotter will unload the current page, display a message on the
front panel, and pop up a window on the node running the plotter
server requesting that the pens be changed.

    Also (please note!) changed from using EVEN parity with the
plotter to using no parity. If you have been using an earlier
version of the plotter server, you will have to change the
plotter's parity setting from the front panel.


Version 6
---------

    Changed way the FLUSH_FLAG is set and cleared to make it consistant
with the order in which the USER1 routines are called by the SR9.5
print server (this flag is used to suppress the output of the printer
configuration info). Changed the USER1_SET_MODE routine so that it will
not asked for the pens to be changed during the startup of the print
server when the print server tries to output the configuration info.


Version 7
---------

    Changed the REQUEST_PENS routine to check the current font size
before popping up the window to request that the pen carosel be changed.
The message used to get chopped off on some display types because the
default font size was different from that used on the DN330 nodes on
which the code was developed.


Version 8
---------

    Change the REQUEST_PENS routine to set the default pen speed and
pen force parameters after the requested pen carosel has been installed
by the user. The plotter will then wait for 20 seconds to allow the
pen speed and force parameters to be changed from the default values
which were automatically set when the plotter detected the new
carosel.




Files Needed to Build the Plot Server
-------------------------------------

    The files which are provided for the HP 7550A plot server are:

        USER1.HP7550.DOC            - This file.
        USER1.HP7550.DOC.INSTALL    - Notes on how to install the plot server.
        PRF.HP7550.HLP              - An edited version of the standard Apollo
                                      help file for the PRF command (/SYS/HELP/PRF.HLP)
                                      with notes included for the HP7550 plotter.
        USER1.HP7550.PAS            - The Pascal sources for the plot server.
        USER1.INS.PAS               - An edited version of the standard Apollo
                                      insert file, /SYS/INS/PRSVR.INS.PAS, which
                                      is used by USER1.HP7550.PAS to define the data
                                      types and structures used by the plot server.
        USER1.HP7550.BLD            - A shell script file for compiling the USER1
                                      routines (and their subroutines) and binding
                                      them with the Apollo supplied print server.
        HP7550.CONFIG               - The configuration file for the HP7550
                                      to be given as an argument to the plot server
                                      when it is started.
        PRSVR.USER1.HP7550          - A ready to run HP7550 plot server. Just in
                                      case you don't have a Pascal compiler. This is
                                      the file which is produced by USER1.HP7550.BLD.


    You will also need the following standard Apollo-supplied files:

        /SYS/INS/BASE.INS.PAS       - These are all standard insert files which
        /SYS/INS/CAL.INS.PAS          are used by USER1.HP7550.PAS.
        /SYS/INS/SIO.INS.PAS
        /SYS/INS/STREAMS.INS.PAS
        /SYS/INS/PAD.INS.PAS
        /SYS/INS/PGM.INS.PAS
        /SYS/INS/TIME.INS.PAS
        /SYS/INS/TONE.INS.PAS
        /SYS/INS/VFMT.INS.PAS
        /COM/PRSVR                  - The standard Apollo print server which must
                                      be bound with the plotter routines to produce
                                      a working print server. Used in USER1.HP7550.BLD to
                                      produce PRSVR.USER1.HP7550.


Bugs, Questions, and Improvements
---------------------------------

    If you find a bugs in the print server, have questions on how to install or
use it, or have a good idea for improving the program please feel free to contact
me at the address below.


            David M. Krowitz
            MIT dept. of Earth, Atmospheric, and Planetary Sciences
            Room 54-527
            Cambridge, MA 02139
            (617) 253-6180


network mailing address:

            mit-erl!mit-kermit!krowitz@eddie.mit.edu
            mit-erl!mit-kermit!krowitz@mit-eddie.arpa
            krowitz@mit-mc.arpa
            (in order of decreasing preference)

